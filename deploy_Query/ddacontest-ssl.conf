#######################################################################
# DDA Contest Apache vHost (HTTPS + HSTS, certbot-ready)
# Place in /etc/apache2/sites-available/ddacontest-ssl.conf
# Then enable with: sudo a2ensite ddacontest-ssl && sudo systemctl reload apache2
#######################################################################

<VirtualHost *:443>
    ServerName ddacontest.com
    ServerAlias www.ddacontest.com
    ServerAdmin decodedataacademy@gmail.com

    SSLEngine on
    SSLCertificateFile    /etc/letsencrypt/live/ddacontest.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/ddacontest.com/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # Strong HSTS (1 year) â€“ enable only when HTTPS works and domain is stable
    <IfModule mod_headers.c>
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set Referrer-Policy "no-referrer-when-downgrade"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https: http: ws: wss:;"
    </IfModule>

    # Static & media (match Django env)
    Alias /static/ /var/www/DDA_Contest/static/
    <Directory /var/www/DDA_Contest/static/>
        Require all granted
        Header set Cache-Control "public, max-age=31536000, immutable"
    </Directory>

    Alias /media/ /var/www/DDA_Contest/media/
    <Directory /var/www/DDA_Contest/media/>
        Require all granted
        Header set Cache-Control "public, max-age=3600"
    </Directory>

    # WSGI (Django)
    WSGIDaemonProcess dda_contest \
        python-home=/var/www/DDA_Contest/venv \
        python-path=/var/www/DDA_Contest/src/student_auth \
        processes=4 threads=2 \
        display-name=%{GROUP}
    WSGIProcessGroup dda_contest
    WSGIScriptAlias / /var/www/DDA_Contest/src/student_auth/student_auth/wsgi.py
    <Directory /var/www/DDA_Contest/src/student_auth/student_auth>
        <Files wsgi.py>
            Require all granted
        </Files>
    </Directory>

    # Env wiring
    SetEnv DJANGO_SETTINGS_MODULE student_auth.settings
    SetEnv ALLOWED_HOSTS ddacontest.com,www.ddacontest.com,localhost,127.0.0.1
    SetEnv DJANGO_STATIC_ROOT /var/www/DDA_Contest/static
    SetEnv DJANGO_MEDIA_ROOT /var/www/DDA_Contest/media

    ErrorLog  ${APACHE_LOG_DIR}/dda_contest_error.log
    CustomLog ${APACHE_LOG_DIR}/dda_contest_access.log combined

    Timeout 60
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5
</VirtualHost>

# Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName ddacontest.com
    ServerAlias www.ddacontest.com
    RewriteEngine On
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>
