#######################################################################
# DDA Contest Production Apache vHost (mod_wsgi)
#
# Project root:           /var/www/DDA_Contest
# Virtualenv (example):   /var/www/DDA_Contest/venv
# Django source package:  /var/www/DDA_Contest/src/student_auth
# WSGI entrypoint:        /var/www/DDA_Contest/src/student_auth/student_auth/wsgi.py
# Static root (collectstatic output): /var/www/DDA_Contest/static
# Media root (user uploads):          /var/www/DDA_Contest/media
#
# BEFORE enabling:
#   python3 -m venv /var/www/DDA_Contest/venv
#   source /var/www/DDA_Contest/venv/bin/activate
#   pip install -r backend/requirements/prod.txt
#   python src/student_auth/manage.py collectstatic --noinput
#   python src/student_auth/manage.py migrate --noinput
#   (optional) python src/student_auth/manage.py createsuperuser
#######################################################################

<VirtualHost *:80>
    ServerName ddacontest.com
    ServerAlias www.ddacontest.com
    ServerAdmin decodedataacademy@gmail.com

    # Logging
    ErrorLog  ${APACHE_LOG_DIR}/dda_contest_error.log
    CustomLog ${APACHE_LOG_DIR}/dda_contest_access.log combined

    # --- Static & Media ------------------------------------------------
    Alias /static/ /var/www/DDA_Contest/static/
    <Directory /var/www/DDA_Contest/static/>
        Require all granted
        Header set Cache-Control "public, max-age=31536000, immutable"
    </Directory>

    Alias /media/ /var/www/DDA_Contest/media/
    <Directory /var/www/DDA_Contest/media/>
        Require all granted
        Header set Cache-Control "public, max-age=3600"
    </Directory>

    # --- WSGI (Django) --------------------------------------------------
    # Ensure python-path points to folder that contains the 'student_auth' package.
    WSGIDaemonProcess dda_contest \
        python-home=/var/www/DDA_Contest/venv \
        python-path=/var/www/DDA_Contest/src/student_auth \
        processes=4 threads=2 \
        display-name=%{GROUP} \
        maximum-requests=2000 \
        listen-backlog=2048 \
        queue-timeout=45 \
        request-timeout=60 \
        inactivity-timeout=300
    WSGIProcessGroup dda_contest

    # Mount Django at root (adjust if you serve a separate built SPA instead)
    WSGIScriptAlias / /var/www/DDA_Contest/src/student_auth/student_auth/wsgi.py

    <Directory /var/www/DDA_Contest/src/student_auth/student_auth>
        <Files wsgi.py>
            Require all granted
        </Files>
    </Directory>

    # Environment variables (prefer a secure external mechanism for secrets)
    SetEnv DJANGO_SETTINGS_MODULE student_auth.settings
    SetEnv ALLOWED_HOSTS ddacontest.com,www.ddacontest.com,localhost,127.0.0.1
    # Ensure Django writes/reads static & media at the paths Apache serves
    SetEnv DJANGO_STATIC_ROOT /var/www/DDA_Contest/static
    SetEnv DJANGO_MEDIA_ROOT /var/www/DDA_Contest/media
    # Example extras (uncomment & adjust):
    # SetEnv POSTGRES_DB dda_contest
    # SetEnv POSTGRES_USER dda_user
    # SetEnv POSTGRES_PASSWORD strong_password_here

    # --- Optional: If you build a frontend (Vite) separately and want SPA fallback ---
    # DocumentRoot /var/www/DDA_Contest/frontend/dist
    # <Directory /var/www/DDA_Contest/frontend/dist>
    #     Require all granted
    #     Options -Indexes +FollowSymLinks
    # </Directory>
    # RewriteEngine On
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteCond %{REQUEST_URI} !^/static/
    # RewriteCond %{REQUEST_URI} !^/media/
    # RewriteRule ^ /index.html [L]

    # --- Security Headers -----------------------------------------------
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set Referrer-Policy "no-referrer-when-downgrade"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https: http: ws: wss:;"
    </IfModule>

    # --- Compression (optional; requires mod_deflate) -------------------
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/css text/javascript application/javascript application/json
    </IfModule>

    # --- Tuning ----------------------------------------------------------
    Timeout 60
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5
</VirtualHost>

# Enable required modules (once):
#   sudo a2enmod headers rewrite wsgi deflate
#   sudo systemctl reload apache2
