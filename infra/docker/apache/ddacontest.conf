# DDA Contest Apache VirtualHost (containerized)
# Assumes backend (Gunicorn) is reachable at http://backend:8000
# Static and media volumes mounted at /var/www/static and /var/www/media

<VirtualHost *:80>
    ServerName _

    # Security headers
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set Referrer-Policy "no-referrer-when-downgrade"
    Header set X-XSS-Protection "1; mode=block"
    Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' http: https: ws: wss:;"

    # API proxy to Django backend
    ProxyPreserveHost On
    ProxyPass /api/ http://backend:8000/api/
    ProxyPassReverse /api/ http://backend:8000/api/

    # Health endpoints
    ProxyPass /healthz http://backend:8000/healthz
    ProxyPassReverse /healthz http://backend:8000/healthz

    # Static & media
    Alias /static/ /var/www/static/
    <Directory /var/www/static/>
        Require all granted
        Header set Cache-Control "public, max-age=31536000, immutable"
    </Directory>

    Alias /media/ /var/www/media/
    <Directory /var/www/media/>
        Require all granted
        Header set Cache-Control "public, max-age=3600"
    </Directory>

    DocumentRoot "/usr/local/apache2/htdocs"
    <Directory "/usr/local/apache2/htdocs">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # SPA fallback (let API/static/media bypass)
    RewriteEngine On
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteCond %{REQUEST_URI} !^/static/
    RewriteCond %{REQUEST_URI} !^/media/
    RewriteRule ^ /index.html [L]

    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>
